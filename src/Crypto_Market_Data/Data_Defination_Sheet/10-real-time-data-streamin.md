# Real-Time Data Streaming

## Overview

This document details the data models that support the platform's Real-Time Data Streaming features. These structures are designed to manage WebSocket connections, streaming subscriptions, push notifications, and real-time data delivery. The primary purpose of these models is to enable efficient real-time data distribution, manage streaming quotas, handle connection lifecycle, and ensure reliable delivery of time-sensitive information to applications and users.

## Relations between Tables

- **WebSocketConnection & User**: A foundational one-to-many relationship that tracks every active real-time session. A single User can have multiple WebSocketConnection records, representing simultaneous connections from different devices or applications (e.g., a web browser and a trading bot). This allows the system to manage the lifecycle, authentication status, and resource usage of each connection independently.
- **StreamingSubscription, WebSocketConnection, & User**: This table acts as a crucial link between a session and the data it requests. A single WebSocketConnection can have many StreamingSubscription records, allowing a client to subscribe to multiple data streams (e.g., BTC prices, ETH trades) over a single connection. The direct link to the User provides a clear ownership trail for enforcing permissions and quotas without needing to traverse through the connection record first.
- **StreamingQuota & User**: This one-to-many relationship is how the platform enforces streaming limits based on a user's subscription tier. Each User has multiple StreamingQuota records, with each record tracking a specific limit, such as the maximum number of concurrent connections or the total messages allowed per hour. This granular structure is essential for fair resource allocation and preventing abuse of the real-time infrastructure.
- **PriceAlert, PushNotificationConfig, & User**: This set of relationships creates a highly flexible notification system. A User can define multiple PushNotificationConfig records, each representing a unique delivery channel (e.g., an email address, a webhook URL, a mobile device token). The PriceAlert table then has a many-to-one relationship with PushNotificationConfig, which allows the user to decide exactly how and where they want to be notified for each specific alert they create.
- **NotificationDelivery & PushNotificationConfig**: This is a logging-focused one-to-many relationship that provides a complete audit trail for all outgoing notifications. Every time the system attempts to send an alert via a specific PushNotificationConfig, a NotificationDelivery record is created. This tracks the entire lifecycle of the message—from PENDING to SENT or FAILED—and stores valuable diagnostic information like provider response codes and failure reasons.

## WebSocketConnection

Manages active WebSocket connections and their lifecycle, supporting feature RT-001.

| Field Name           | Type      | Required? | Format                                         | Description                                                                  |
| -------------------- | --------- | --------- | ---------------------------------------------- | ---------------------------------------------------------------------------- |
| connection_id        | UUID      | Yes       | UUID                                           | Primary key for the WebSocket connection.                                    |
| user_id              | UUID      | Yes       | UUID                                           | Foreign key linking to the User table.                                       |
| session_id           | String    | Yes       | Alphanumeric                                   | Unique session identifier for the connection, generated by the server.       |
| connection_status    | Enum      | Yes       | CONNECTING, ACTIVE, IDLE, DISCONNECTED, FAILED | Current connection status.                                                   |
| server_endpoint      | String    | Yes       | URL                                            | WebSocket server endpoint (node) handling this connection.                   |
| client_ip            | String    | Yes       | IP address                                     | Client IP address of the connection.                                         |
| user_agent           | String    | No        | Free text                                      | Client user agent string for identification.                                 |
| protocol_version     | String    | Yes       | e.g., "v1.0"                                   | The version of the WebSocket protocol being used.                            |
| connected_at         | Timestamp | Yes       | ISO 8601                                       | When the connection was successfully established.                            |
| last_ping_at         | Timestamp | No        | ISO 8601                                       | The timestamp of the last received client ping or server heartbeat.          |
| last_activity_at     | Timestamp | Yes       | ISO 8601                                       | The timestamp of the last message or activity on this connection.            |
| disconnected_at      | Timestamp | No        | ISO 8601                                       | When the connection was closed.                                              |
| disconnect_reason    | String    | No        | Free text                                      | Reason for disconnection (e.g., "client-close", "timeout", "error").         |
| auto_reconnect       | Boolean   | Yes       | true/false                                     | Whether the client has indicated it supports auto-reconnection.              |
| compression_enabled  | Boolean   | Yes       | true/false                                     | Whether data compression (e.g., permessage-deflate) is enabled.              |
| rate_limit_remaining | Integer   | Yes       | Non-negative integer                           | The remaining message rate limit for the current window for this connection. |
| subscription_count   | Integer   | Yes       | Non-negative integer                           | The number of active subscriptions on this connection.                       |
| bytes_sent           | BigInt    | Yes       | Non-negative integer                           | Total bytes sent from the server to the client.                              |
| bytes_received       | BigInt    | Yes       | Non-negative integer                           | Total bytes received from the client by the server.                          |
| created_at           | Timestamp | Yes       | ISO 8601                                       | When the connection record was created in the database.                      |
| updated_at           | Timestamp | Yes       | ISO 8601                                       | When the connection record was last updated.                                 |

## StreamingSubscription

Manages user subscriptions to specific real-time data streams, supporting feature RT-001.

| Field Name            | Type      | Required? | Format                                         | Description                                                                           |
| --------------------- | --------- | --------- | ---------------------------------------------- | ------------------------------------------------------------------------------------- |
| subscription_id       | UUID      | Yes       | UUID                                           | Primary key for the streaming subscription.                                           |
| connection_id         | UUID      | Yes       | UUID                                           | Foreign key linking to the parent WebSocketConnection.                                |
| user_id               | UUID      | Yes       | UUID                                           | Foreign key linking to the User table for permission checks.                          |
| stream_type           | Enum      | Yes       | PRICE_TICKER, ORDER_BOOK, TRADES, MARKET_STATS | The type of data stream being subscribed to.                                          |
| asset_symbol          | String    | No        | e.g., "BTC", "ETH"                             | Specific asset symbol (null for multi-asset streams).                                 |
| market_pair           | String    | No        | e.g., "BTC/USDT"                               | Trading pair for market-specific streams.                                             |
| exchange_id           | UUID      | No        | UUID                                           | Specific exchange filter (null for aggregated data).                                  |
| subscription_params   | JSON      | No        | JSON object                                    | Additional subscription parameters (e.g., filters, intervals, depth for order books). |
| status                | Enum      | Yes       | ACTIVE, PAUSED, CANCELLED, ERROR               | The current status of the subscription.                                               |
| subscribed_at         | Timestamp | Yes       | ISO 8601                                       | When the subscription was created.                                                    |
| last_data_sent_at     | Timestamp | No        | ISO 8601                                       | The timestamp when data was last sent for this subscription.                          |
| message_count         | BigInt    | Yes       | Non-negative integer                           | The total number of messages sent for this subscription.                              |
| error_count           | Integer   | Yes       | Non-negative integer                           | The number of errors encountered while processing this subscription.                  |
| last_error_at         | Timestamp | No        | ISO 8601                                       | The timestamp of the last error.                                                      |
| last_error_message    | Text      | No        | Free text                                      | The message from the last error encountered.                                          |
| priority              | Integer   | Yes       | 1-10                                           | Subscription priority for resource allocation (higher is more important).             |
| rate_limit_per_second | Integer   | Yes       | Positive integer                               | The maximum messages per second allowed for this subscription.                        |
| created_at            | Timestamp | Yes       | ISO 8601                                       | When the subscription record was created.                                             |
| updated_at            | Timestamp | Yes       | ISO 8601                                       | When the subscription record was last updated.                                        |

## StreamingQuota

Manages streaming quotas and usage limits per user, supporting feature RT-001.

| Field Name         | Type      | Required? | Format                                                   | Description                                                                  |
| ------------------ | --------- | --------- | -------------------------------------------------------- | ---------------------------------------------------------------------------- |
| user_id            | UUID      | Yes       | UUID                                                     | Foreign key to User table. Part of the composite primary key.                |
| quota_type         | Enum      | Yes       | CONCURRENT_CONNECTIONS, SUBSCRIPTIONS, MESSAGES_PER_HOUR | The type of streaming quota being tracked. Part of the composite key.        |
| allocated_quota    | Integer   | Yes       | Positive integer                                         | The maximum quota allocated based on the user's subscription tier.           |
| used_quota         | Integer   | Yes       | Non-negative integer                                     | The current usage against the allocated quota.                               |
| peak_usage         | Integer   | Yes       | Non-negative integer                                     | The highest usage recorded in the current period for analysis.               |
| reset_period_hours | Integer   | Yes       | Positive integer                                         | The number of hours between quota resets (e.g., 1 for hourly, 24 for daily). |
| last_reset_at      | Timestamp | Yes       | ISO 8601                                                 | The timestamp when the quota was last reset.                                 |
| next_reset_at      | Timestamp | Yes       | ISO 8601                                                 | The timestamp when the quota will next reset.                                |
| warning_threshold  | Float     | Yes       | 0.0 - 1.0                                                | The percentage threshold for sending usage warnings (e.g., 0.8 for 80%).     |
| warning_sent       | Boolean   | Yes       | true/false                                               | A flag to indicate if a warning has been sent for the current period.        |
| overage_allowed    | Boolean   | Yes       | true/false                                               | Whether usage can exceed the quota (potentially incurring extra charges).    |
| overage_multiplier | Float     | No        | > 1.0                                                    | The maximum overage allowed, expressed as a multiplier of the base quota.    |
| updated_at         | Timestamp | Yes       | ISO 8601                                                 | When the quota usage was last updated.                                       |

## PushNotificationConfig

Stores user notification preferences and delivery channel settings, supporting feature RT-002.

| Field Name            | Type      | Required? | Format                                         | Description                                                            |
| --------------------- | --------- | --------- | ---------------------------------------------- | ---------------------------------------------------------------------- |
| config_id             | UUID      | Yes       | UUID                                           | Primary key for the notification configuration.                        |
| user_id               | UUID      | Yes       | UUID                                           | Foreign key linking to the User table.                                 |
| notification_type     | Enum      | Yes       | PRICE_ALERT, MARKET_EVENT, SYSTEM_NOTIFICATION | The general type of notification this config applies to.               |
| delivery_channel      | Enum      | Yes       | EMAIL, SMS, WEBHOOK, PUSH_NOTIFICATION         | The specific delivery method or channel.                               |
| is_enabled            | Boolean   | Yes       | true/false                                     | Whether this notification channel is currently enabled by the user.    |
| delivery_address      | String    | Yes       | Contact info                                   | The destination address (e.g., email, phone number, or webhook URL).   |
| delivery_schedule     | JSON      | No        | JSON object                                    | Time-based delivery preferences (e.g., daily digests, specific hours). |
| priority_level        | Enum      | Yes       | LOW, MEDIUM, HIGH, URGENT                      | The priority level of notifications sent via this channel.             |
| retry_attempts        | Integer   | Yes       | 0-10                                           | The maximum number of delivery retry attempts on failure.              |
| retry_delay_minutes   | Integer   | Yes       | Positive integer                               | The number of minutes to wait between retry attempts.                  |
| confirmation_required | Boolean   | Yes       | true/false                                     | Whether delivery confirmation from the provider is required.           |
| rate_limit_per_hour   | Integer   | Yes       | Positive integer                               | The maximum number of notifications to send per hour via this channel. |
| quiet_hours_start     | Time      | No        | HH:MM                                          | The start of a "do not disturb" period.                                |
| quiet_hours_end       | Time      | No        | HH:MM                                          | The end of a "do not disturb" period.                                  |
| timezone              | String    | Yes       | e.g., "UTC", "America/New_York"                | The user's timezone for scheduling and quiet hours.                    |
| custom_template       | Text      | No        | Template string                                | A user-defined message template (e.g., using Mustache or Handlebars).  |
| metadata              | JSON      | No        | JSON object                                    | Additional configuration parameters specific to the channel.           |
| created_at            | Timestamp | Yes       | ISO 8601                                       | When the configuration was created.                                    |
| updated_at            | Timestamp | Yes       | ISO 8601                                       | When the configuration was last updated.                               |

## NotificationDelivery

Time-series table logging notification delivery attempts and status, supporting feature RT-002.

| Field Name            | Type      | Required? | Format                                         | Description                                                                               |
| --------------------- | --------- | --------- | ---------------------------------------------- | ----------------------------------------------------------------------------------------- |
| delivery_id           | UUID      | Yes       | UUID                                           | Primary key for the delivery record.                                                      |
| user_id               | UUID      | Yes       | UUID                                           | Foreign key linking to the User table.                                                    |
| config_id             | UUID      | Yes       | UUID                                           | Foreign key linking to the PushNotificationConfig used for this delivery.                 |
| notification_type     | Enum      | Yes       | PRICE_ALERT, MARKET_EVENT, SYSTEM_NOTIFICATION | The type of notification that was sent.                                                   |
| delivery_channel      | Enum      | Yes       | EMAIL, SMS, WEBHOOK, PUSH_NOTIFICATION         | The delivery method that was used.                                                        |
| delivery_address      | String    | Yes       | Contact info                                   | The specific destination address where the notification was sent.                         |
| message_content       | Text      | Yes       | Free text                                      | The final, rendered content of the notification message.                                  |
| subject_line          | String    | No        | Free text                                      | The email subject or notification title, if applicable.                                   |
| trigger_event         | String    | Yes       | Free text                                      | A description of the event that triggered this notification (e.g., "BTC price > $70000"). |
| trigger_data          | JSON      | No        | JSON object                                    | The data related to the trigger event (e.g., actual price, volume).                       |
| scheduled_at          | Timestamp | Yes       | ISO 8601                                       | When the notification was scheduled for delivery.                                         |
| sent_at               | Timestamp | No        | ISO 8601                                       | The timestamp when the notification was actually sent.                                    |
| delivery_status       | Enum      | Yes       | PENDING, SENT, DELIVERED, FAILED, REJECTED     | The current delivery status, as reported by the provider.                                 |
| delivery_confirmed_at | Timestamp | No        | ISO 8601                                       | The timestamp when delivery was confirmed by the provider.                                |
| failure_reason        | String    | No        | Free text                                      | The reason for delivery failure, if any.                                                  |
| retry_count           | Integer   | Yes       | Non-negative integer                           | The number of retry attempts that have been made.                                         |
| last_retry_at         | Timestamp | No        | ISO 8601                                       | The timestamp of the last retry attempt.                                                  |
| external_id           | String    | No        | Free text                                      | The delivery ID from the external provider (e.g., SendGrid, Twilio).                      |
| response_code         | Integer   | No        | HTTP status code                               | The response code from the provider's API (e.g., 200, 404).                               |
| response_message      | Text      | No        | Free text                                      | The response message from the provider's API.                                             |
| processing_time_ms    | Integer   | No        | Milliseconds                                   | The time taken for the system to process and send the notification.                       |
| created_at            | Timestamp | Yes       | ISO 8601                                       | When the delivery record was created.                                                     |

## PriceAlert

Stores user-defined price alerts and their trigger conditions, supporting feature RT-002.

| Field Name             | Type      | Required? | Format                                                   | Description                                                                |
| ---------------------- | --------- | --------- | -------------------------------------------------------- | -------------------------------------------------------------------------- |
| alert_id               | UUID      | Yes       | UUID                                                     | Primary key for the price alert.                                           |
| user_id                | UUID      | Yes       | UUID                                                     | Foreign key linking to the User table.                                     |
| asset_symbol           | String    | Yes       | e.g., "BTC", "ETH"                                       | The asset symbol to monitor.                                               |
| market_pair            | String    | No        | e.g., "BTC/USDT"                                         | A specific trading pair (null for globally aggregated price).              |
| exchange_id            | UUID      | No        | UUID                                                     | A specific exchange (null for aggregated price).                           |
| alert_type             | Enum      | Yes       | PRICE_ABOVE, PRICE_BELOW, PRICE_CHANGE_PCT, VOLUME_SPIKE | The type of condition that triggers the alert.                             |
| threshold_value        | Decimal   | Yes       | Numeric                                                  | The threshold value for the alert condition.                               |
| current_value          | Decimal   | No        | Numeric                                                  | The current value of the metric being monitored.                           |
| alert_name             | String    | No        | Free text                                                | A user-defined name for the alert for easy identification.                 |
| is_active              | Boolean   | Yes       | true/false                                               | Whether the alert is currently active and being monitored.                 |
| is_repeating           | Boolean   | Yes       | true/false                                               | Whether the alert should automatically re-arm after triggering.            |
| cooldown_minutes       | Integer   | No        | Positive integer                                         | The number of minutes to wait before a repeating alert can trigger again.  |
| created_at             | Timestamp | Yes       | ISO 8601                                                 | When the alert was created.                                                |
| last_triggered_at      | Timestamp | No        | ISO 8601                                                 | The timestamp when the alert was last triggered.                           |
| trigger_count          | Integer   | Yes       | Non-negative integer                                     | The number of times this alert has been triggered.                         |
| expires_at             | Timestamp | No        | ISO 8601                                                 | The timestamp when the alert expires (null for permanent alerts).          |
| priority               | Enum      | Yes       | LOW, MEDIUM, HIGH                                        | The priority level of the alert.                                           |
| notification_config_id | UUID      | Yes       | UUID                                                     | Foreign key to the PushNotificationConfig to use when this alert triggers. |
| updated_at             | Timestamp | Yes       | ISO 8601                                                 | When the alert was last updated.                                           |

## Relationships

- **User** [user_id (PK)] 1 => \* **WebSocketConnection** [user_id (FK)]
- **WebSocketConnection** [connection_id (PK)] 1 => \* **StreamingSubscription** [connection_id (FK)]
- **User** [user_id (PK)] 1 => \* **StreamingSubscription** [user_id (FK)]
- **User** [user_id (PK)] 1 => \* **StreamingQuota** [user_id (FK)]
- **User** [user_id (PK)] 1 => \* **PushNotificationConfig** [user_id (FK)]
- **PushNotificationConfig** [config_id (PK)] 1 => \* **NotificationDelivery** [config_id (FK)]
- **User** [user_id (PK)] 1 => \* **PriceAlert** [user_id (FK)]
- **PushNotificationConfig** [config_id (PK)] 1 => \* **PriceAlert** [notification_config_id (FK)]

## Entities & Relationships

### WebSocketConnection

- **connection_id** (PK)
- **user_id** (FK → User.user_id)

### StreamingSubscription

- **subscription_id** (PK)
- **connection_id** (FK → WebSocketConnection.connection_id)
- **user_id** (FK → User.user_id)

### StreamingQuota

- **user_id** (PK, FK → User.user_id)
- **quota_type** (PK)

### PushNotificationConfig

- **config_id** (PK)
- **user_id** (FK → User.user_id)

### NotificationDelivery

- **delivery_id** (PK)
- **user_id** (FK → User.user_id)
- **config_id** (FK → PushNotificationConfig.config_id)

### PriceAlert

- **alert_id** (PK)
- **user_id** (FK → User.user_id)
- **notification_config_id** (FK → PushNotificationConfig.config_id)
